/* I2S Example

	This example code will output 100Hz sine wave and triangle wave to 2-channel of I2S driver
	Every 5 seconds, it will change bits_per_sample [16, 24, 32] for i2s data

	This example code is in the Public Domain (or CC0 licensed, at your option.)

	Unless required by applicable law or agreed to in writing, this
	software is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
	CONDITIONS OF ANY KIND, either express or implied.
*/
#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/i2s.h"
#include "driver/gpio.h"
#include "esp_system.h"
#include "esp_log.h"
#include <math.h>
#include "wavetable.h"
#include "scale.h"
#include "encoder.h"

#define I2S_NUM (0)
#define PI (3.14159265)
#define I2S_BCK_IO (GPIO_NUM_19)
#define I2S_WS_IO (GPIO_NUM_21)
#define I2S_DO_IO (GPIO_NUM_22)
#define I2S_DI_IO (-1)

uint16_t sine_wt[1024] =
	{
		0x2000,
		0x2032,
		0x2064,
		0x2096,
		0x20c9,
		0x20fb,
		0x212d,
		0x2160,
		0x2192,
		0x21c4,
		0x21f6,
		0x2229,
		0x225b,
		0x228d,
		0x22bf,
		0x22f1,
		0x2323,
		0x2355,
		0x2387,
		0x23b9,
		0x23eb,
		0x241d,
		0x244f,
		0x2481,
		0x24b3,
		0x24e4,
		0x2516,
		0x2548,
		0x2579,
		0x25ab,
		0x25dc,
		0x260e,
		0x263f,
		0x2670,
		0x26a2,
		0x26d3,
		0x2704,
		0x2735,
		0x2766,
		0x2797,
		0x27c8,
		0x27f9,
		0x2829,
		0x285a,
		0x288a,
		0x28bb,
		0x28eb,
		0x291b,
		0x294c,
		0x297c,
		0x29ac,
		0x29dc,
		0x2a0b,
		0x2a3b,
		0x2a6b,
		0x2a9a,
		0x2aca,
		0x2af9,
		0x2b28,
		0x2b57,
		0x2b86,
		0x2bb5,
		0x2be4,
		0x2c13,
		0x2c41,
		0x2c70,
		0x2c9e,
		0x2ccc,
		0x2cfa,
		0x2d28,
		0x2d56,
		0x2d83,
		0x2db1,
		0x2dde,
		0x2e0c,
		0x2e39,
		0x2e66,
		0x2e93,
		0x2ebf,
		0x2eec,
		0x2f18,
		0x2f45,
		0x2f71,
		0x2f9d,
		0x2fc9,
		0x2ff4,
		0x3020,
		0x304b,
		0x3076,
		0x30a2,
		0x30cc,
		0x30f7,
		0x3122,
		0x314c,
		0x3176,
		0x31a0,
		0x31ca,
		0x31f4,
		0x321e,
		0x3247,
		0x3270,
		0x3299,
		0x32c2,
		0x32eb,
		0x3313,
		0x333c,
		0x3364,
		0x338c,
		0x33b3,
		0x33db,
		0x3402,
		0x3429,
		0x3450,
		0x3477,
		0x349e,
		0x34c4,
		0x34ea,
		0x3510,
		0x3536,
		0x355c,
		0x3581,
		0x35a6,
		0x35cb,
		0x35f0,
		0x3614,
		0x3639,
		0x365d,
		0x3681,
		0x36a4,
		0x36c8,
		0x36eb,
		0x370e,
		0x3731,
		0x3753,
		0x3776,
		0x3798,
		0x37b9,
		0x37db,
		0x37fd,
		0x381e,
		0x383f,
		0x385f,
		0x3880,
		0x38a0,
		0x38c0,
		0x38e0,
		0x38ff,
		0x391f,
		0x393e,
		0x395d,
		0x397b,
		0x3999,
		0x39b7,
		0x39d5,
		0x39f3,
		0x3a10,
		0x3a2d,
		0x3a4a,
		0x3a67,
		0x3a83,
		0x3a9f,
		0x3abb,
		0x3ad6,
		0x3af1,
		0x3b0c,
		0x3b27,
		0x3b42,
		0x3b5c,
		0x3b76,
		0x3b90,
		0x3ba9,
		0x3bc2,
		0x3bdb,
		0x3bf4,
		0x3c0c,
		0x3c24,
		0x3c3c,
		0x3c53,
		0x3c6b,
		0x3c82,
		0x3c98,
		0x3caf,
		0x3cc5,
		0x3cdb,
		0x3cf0,
		0x3d06,
		0x3d1b,
		0x3d30,
		0x3d44,
		0x3d58,
		0x3d6c,
		0x3d80,
		0x3d93,
		0x3da6,
		0x3db9,
		0x3dcb,
		0x3dde,
		0x3def,
		0x3e01,
		0x3e12,
		0x3e23,
		0x3e34,
		0x3e45,
		0x3e55,
		0x3e65,
		0x3e74,
		0x3e84,
		0x3e93,
		0x3ea1,
		0x3eb0,
		0x3ebe,
		0x3ecc,
		0x3ed9,
		0x3ee6,
		0x3ef3,
		0x3f00,
		0x3f0c,
		0x3f18,
		0x3f24,
		0x3f2f,
		0x3f3a,
		0x3f45,
		0x3f50,
		0x3f5a,
		0x3f64,
		0x3f6d,
		0x3f77,
		0x3f80,
		0x3f88,
		0x3f91,
		0x3f99,
		0x3fa1,
		0x3fa8,
		0x3faf,
		0x3fb6,
		0x3fbd,
		0x3fc3,
		0x3fc9,
		0x3fce,
		0x3fd4,
		0x3fd9,
		0x3fdd,
		0x3fe2,
		0x3fe6,
		0x3fea,
		0x3fed,
		0x3ff0,
		0x3ff3,
		0x3ff6,
		0x3ff8,
		0x3ffa,
		0x3ffc,
		0x3ffd,
		0x3ffe,
		0x3fff,
		0x3fff,
		0x3fff,
		0x3fff,
		0x3ffe,
		0x3ffd,
		0x3ffc,
		0x3ffb,
		0x3ff9,
		0x3ff7,
		0x3ff4,
		0x3ff2,
		0x3fef,
		0x3feb,
		0x3fe8,
		0x3fe4,
		0x3fe0,
		0x3fdb,
		0x3fd6,
		0x3fd1,
		0x3fcc,
		0x3fc6,
		0x3fc0,
		0x3fb9,
		0x3fb3,
		0x3fac,
		0x3fa4,
		0x3f9d,
		0x3f95,
		0x3f8d,
		0x3f84,
		0x3f7b,
		0x3f72,
		0x3f69,
		0x3f5f,
		0x3f55,
		0x3f4a,
		0x3f40,
		0x3f35,
		0x3f2a,
		0x3f1e,
		0x3f12,
		0x3f06,
		0x3efa,
		0x3eed,
		0x3ee0,
		0x3ed2,
		0x3ec5,
		0x3eb7,
		0x3ea8,
		0x3e9a,
		0x3e8b,
		0x3e7c,
		0x3e6d,
		0x3e5d,
		0x3e4d,
		0x3e3c,
		0x3e2c,
		0x3e1b,
		0x3e0a,
		0x3df8,
		0x3de7,
		0x3dd5,
		0x3dc2,
		0x3db0,
		0x3d9d,
		0x3d89,
		0x3d76,
		0x3d62,
		0x3d4e,
		0x3d3a,
		0x3d25,
		0x3d10,
		0x3cfb,
		0x3ce6,
		0x3cd0,
		0x3cba,
		0x3ca4,
		0x3c8d,
		0x3c76,
		0x3c5f,
		0x3c48,
		0x3c30,
		0x3c18,
		0x3c00,
		0x3be7,
		0x3bcf,
		0x3bb6,
		0x3b9c,
		0x3b83,
		0x3b69,
		0x3b4f,
		0x3b34,
		0x3b1a,
		0x3aff,
		0x3ae4,
		0x3ac8,
		0x3aad,
		0x3a91,
		0x3a75,
		0x3a58,
		0x3a3c,
		0x3a1f,
		0x3a01,
		0x39e4,
		0x39c6,
		0x39a8,
		0x398a,
		0x396c,
		0x394d,
		0x392e,
		0x390f,
		0x38f0,
		0x38d0,
		0x38b0,
		0x3890,
		0x3870,
		0x384f,
		0x382e,
		0x380d,
		0x37ec,
		0x37ca,
		0x37a9,
		0x3787,
		0x3764,
		0x3742,
		0x371f,
		0x36fc,
		0x36d9,
		0x36b6,
		0x3692,
		0x366f,
		0x364b,
		0x3626,
		0x3602,
		0x35dd,
		0x35b9,
		0x3594,
		0x356e,
		0x3549,
		0x3523,
		0x34fd,
		0x34d7,
		0x34b1,
		0x348a,
		0x3464,
		0x343d,
		0x3416,
		0x33ef,
		0x33c7,
		0x33a0,
		0x3378,
		0x3350,
		0x3327,
		0x32ff,
		0x32d6,
		0x32ae,
		0x3285,
		0x325c,
		0x3232,
		0x3209,
		0x31df,
		0x31b5,
		0x318b,
		0x3161,
		0x3137,
		0x310c,
		0x30e2,
		0x30b7,
		0x308c,
		0x3061,
		0x3036,
		0x300a,
		0x2fdf,
		0x2fb3,
		0x2f87,
		0x2f5b,
		0x2f2f,
		0x2f02,
		0x2ed6,
		0x2ea9,
		0x2e7c,
		0x2e4f,
		0x2e22,
		0x2df5,
		0x2dc8,
		0x2d9a,
		0x2d6d,
		0x2d3f,
		0x2d11,
		0x2ce3,
		0x2cb5,
		0x2c87,
		0x2c58,
		0x2c2a,
		0x2bfb,
		0x2bcd,
		0x2b9e,
		0x2b6f,
		0x2b40,
		0x2b11,
		0x2ae1,
		0x2ab2,
		0x2a83,
		0x2a53,
		0x2a23,
		0x29f4,
		0x29c4,
		0x2994,
		0x2964,
		0x2934,
		0x2903,
		0x28d3,
		0x28a3,
		0x2872,
		0x2842,
		0x2811,
		0x27e0,
		0x27af,
		0x277e,
		0x274e,
		0x271d,
		0x26eb,
		0x26ba,
		0x2689,
		0x2658,
		0x2626,
		0x25f5,
		0x25c4,
		0x2592,
		0x2560,
		0x252f,
		0x24fd,
		0x24cb,
		0x249a,
		0x2468,
		0x2436,
		0x2404,
		0x23d2,
		0x23a0,
		0x236e,
		0x233c,
		0x230a,
		0x22d8,
		0x22a6,
		0x2274,
		0x2242,
		0x220f,
		0x21dd,
		0x21ab,
		0x2179,
		0x2146,
		0x2114,
		0x20e2,
		0x20b0,
		0x207d,
		0x204b,
		0x2019,
		0x1fe6,
		0x1fb4,
		0x1f82,
		0x1f4f,
		0x1f1d,
		0x1eeb,
		0x1eb9,
		0x1e86,
		0x1e54,
		0x1e22,
		0x1df0,
		0x1dbd,
		0x1d8b,
		0x1d59,
		0x1d27,
		0x1cf5,
		0x1cc3,
		0x1c91,
		0x1c5f,
		0x1c2d,
		0x1bfb,
		0x1bc9,
		0x1b97,
		0x1b65,
		0x1b34,
		0x1b02,
		0x1ad0,
		0x1a9f,
		0x1a6d,
		0x1a3b,
		0x1a0a,
		0x19d9,
		0x19a7,
		0x1976,
		0x1945,
		0x1914,
		0x18e2,
		0x18b1,
		0x1881,
		0x1850,
		0x181f,
		0x17ee,
		0x17bd,
		0x178d,
		0x175c,
		0x172c,
		0x16fc,
		0x16cb,
		0x169b,
		0x166b,
		0x163b,
		0x160b,
		0x15dc,
		0x15ac,
		0x157c,
		0x154d,
		0x151e,
		0x14ee,
		0x14bf,
		0x1490,
		0x1461,
		0x1432,
		0x1404,
		0x13d5,
		0x13a7,
		0x1378,
		0x134a,
		0x131c,
		0x12ee,
		0x12c0,
		0x1292,
		0x1265,
		0x1237,
		0x120a,
		0x11dd,
		0x11b0,
		0x1183,
		0x1156,
		0x1129,
		0x10fd,
		0x10d0,
		0x10a4,
		0x1078,
		0x104c,
		0x1020,
		0xff5,
		0xfc9,
		0xf9e,
		0xf73,
		0xf48,
		0xf1d,
		0xef3,
		0xec8,
		0xe9e,
		0xe74,
		0xe4a,
		0xe20,
		0xdf6,
		0xdcd,
		0xda3,
		0xd7a,
		0xd51,
		0xd29,
		0xd00,
		0xcd8,
		0xcaf,
		0xc87,
		0xc5f,
		0xc38,
		0xc10,
		0xbe9,
		0xbc2,
		0xb9b,
		0xb75,
		0xb4e,
		0xb28,
		0xb02,
		0xadc,
		0xab6,
		0xa91,
		0xa6b,
		0xa46,
		0xa22,
		0x9fd,
		0x9d9,
		0x9b4,
		0x990,
		0x96d,
		0x949,
		0x926,
		0x903,
		0x8e0,
		0x8bd,
		0x89b,
		0x878,
		0x856,
		0x835,
		0x813,
		0x7f2,
		0x7d1,
		0x7b0,
		0x78f,
		0x76f,
		0x74f,
		0x72f,
		0x70f,
		0x6f0,
		0x6d1,
		0x6b2,
		0x693,
		0x675,
		0x657,
		0x639,
		0x61b,
		0x5fe,
		0x5e0,
		0x5c3,
		0x5a7,
		0x58a,
		0x56e,
		0x552,
		0x537,
		0x51b,
		0x500,
		0x4e5,
		0x4cb,
		0x4b0,
		0x496,
		0x47c,
		0x463,
		0x449,
		0x430,
		0x418,
		0x3ff,
		0x3e7,
		0x3cf,
		0x3b7,
		0x3a0,
		0x389,
		0x372,
		0x35b,
		0x345,
		0x32f,
		0x319,
		0x304,
		0x2ef,
		0x2da,
		0x2c5,
		0x2b1,
		0x29d,
		0x289,
		0x276,
		0x262,
		0x24f,
		0x23d,
		0x22a,
		0x218,
		0x207,
		0x1f5,
		0x1e4,
		0x1d3,
		0x1c3,
		0x1b2,
		0x1a2,
		0x192,
		0x183,
		0x174,
		0x165,
		0x157,
		0x148,
		0x13a,
		0x12d,
		0x11f,
		0x112,
		0x105,
		0xf9,
		0xed,
		0xe1,
		0xd5,
		0xca,
		0xbf,
		0xb5,
		0xaa,
		0xa0,
		0x96,
		0x8d,
		0x84,
		0x7b,
		0x72,
		0x6a,
		0x62,
		0x5b,
		0x53,
		0x4c,
		0x46,
		0x3f,
		0x39,
		0x33,
		0x2e,
		0x29,
		0x24,
		0x1f,
		0x1b,
		0x17,
		0x14,
		0x10,
		0xd,
		0xb,
		0x8,
		0x6,
		0x4,
		0x3,
		0x2,
		0x1,
		0x0,
		0x0,
		0x0,
		0x0,
		0x1,
		0x2,
		0x3,
		0x5,
		0x7,
		0x9,
		0xc,
		0xf,
		0x12,
		0x15,
		0x19,
		0x1d,
		0x22,
		0x26,
		0x2b,
		0x31,
		0x36,
		0x3c,
		0x42,
		0x49,
		0x50,
		0x57,
		0x5e,
		0x66,
		0x6e,
		0x77,
		0x7f,
		0x88,
		0x92,
		0x9b,
		0xa5,
		0xaf,
		0xba,
		0xc5,
		0xd0,
		0xdb,
		0xe7,
		0xf3,
		0xff,
		0x10c,
		0x119,
		0x126,
		0x133,
		0x141,
		0x14f,
		0x15e,
		0x16c,
		0x17b,
		0x18b,
		0x19a,
		0x1aa,
		0x1ba,
		0x1cb,
		0x1dc,
		0x1ed,
		0x1fe,
		0x210,
		0x221,
		0x234,
		0x246,
		0x259,
		0x26c,
		0x27f,
		0x293,
		0x2a7,
		0x2bb,
		0x2cf,
		0x2e4,
		0x2f9,
		0x30f,
		0x324,
		0x33a,
		0x350,
		0x367,
		0x37d,
		0x394,
		0x3ac,
		0x3c3,
		0x3db,
		0x3f3,
		0x40b,
		0x424,
		0x43d,
		0x456,
		0x46f,
		0x489,
		0x4a3,
		0x4bd,
		0x4d8,
		0x4f3,
		0x50e,
		0x529,
		0x544,
		0x560,
		0x57c,
		0x598,
		0x5b5,
		0x5d2,
		0x5ef,
		0x60c,
		0x62a,
		0x648,
		0x666,
		0x684,
		0x6a2,
		0x6c1,
		0x6e0,
		0x700,
		0x71f,
		0x73f,
		0x75f,
		0x77f,
		0x7a0,
		0x7c0,
		0x7e1,
		0x802,
		0x824,
		0x846,
		0x867,
		0x889,
		0x8ac,
		0x8ce,
		0x8f1,
		0x914,
		0x937,
		0x95b,
		0x97e,
		0x9a2,
		0x9c6,
		0x9eb,
		0xa0f,
		0xa34,
		0xa59,
		0xa7e,
		0xaa3,
		0xac9,
		0xaef,
		0xb15,
		0xb3b,
		0xb61,
		0xb88,
		0xbaf,
		0xbd6,
		0xbfd,
		0xc24,
		0xc4c,
		0xc73,
		0xc9b,
		0xcc3,
		0xcec,
		0xd14,
		0xd3d,
		0xd66,
		0xd8f,
		0xdb8,
		0xde1,
		0xe0b,
		0xe35,
		0xe5f,
		0xe89,
		0xeb3,
		0xedd,
		0xf08,
		0xf33,
		0xf5d,
		0xf89,
		0xfb4,
		0xfdf,
		0x100b,
		0x1036,
		0x1062,
		0x108e,
		0x10ba,
		0x10e7,
		0x1113,
		0x1140,
		0x116c,
		0x1199,
		0x11c6,
		0x11f3,
		0x1221,
		0x124e,
		0x127c,
		0x12a9,
		0x12d7,
		0x1305,
		0x1333,
		0x1361,
		0x138f,
		0x13be,
		0x13ec,
		0x141b,
		0x144a,
		0x1479,
		0x14a8,
		0x14d7,
		0x1506,
		0x1535,
		0x1565,
		0x1594,
		0x15c4,
		0x15f4,
		0x1623,
		0x1653,
		0x1683,
		0x16b3,
		0x16e4,
		0x1714,
		0x1744,
		0x1775,
		0x17a5,
		0x17d6,
		0x1806,
		0x1837,
		0x1868,
		0x1899,
		0x18ca,
		0x18fb,
		0x192c,
		0x195d,
		0x198f,
		0x19c0,
		0x19f1,
		0x1a23,
		0x1a54,
		0x1a86,
		0x1ab7,
		0x1ae9,
		0x1b1b,
		0x1b4c,
		0x1b7e,
		0x1bb0,
		0x1be2,
		0x1c14,
		0x1c46,
		0x1c78,
		0x1caa,
		0x1cdc,
		0x1d0e,
		0x1d40,
		0x1d72,
		0x1da4,
		0x1dd6,
		0x1e09,
		0x1e3b,
		0x1e6d,
		0x1e9f,
		0x1ed2,
		0x1f04,
		0x1f36,
		0x1f69,
		0x1f9b,
		0x1fcd,
		0x2000,
};

void i2s_write_freq(double frequency)
{
	size_t i2s_bytes_write = 0;
	uint32_t data_size = ((AUDIO_RESOLUTION_BIT + 8) / 16) * WT_SIZE * 4;
	int *samples_data = malloc(data_size);
	uint sample_val = 0;

	double frqTL = WT_SIZE / SAMPLE_RATE;
	double indexIncr = (frqTL * frequency);
	double index = 0;

	printf("%lf\n%lf\n", frqTL, frqTL * frequency);

	for (int n = 0; n < WT_SIZE; n++)
	{

		// sample_val = 0;
		// sample_val |= sine_wt[(int)index];
		// // sample_val = sample_val << 16;
		// // sample_val |= sine_wt[(int)index];
		// samples_data[n] = sample_val;
		uint16_t mul = ((1 << 16) / 10) - 1;

		sample_val = 0;
		sample_val += (uint16_t)(mul * (interpol_float(get_wavetable(TRI_WT), index)));
		sample_val = sample_val << 16;
		sample_val += (uint16_t)(mul * get_wavetable(TRI_WT)[(int)index]);
		samples_data[n] = sample_val;

		index += indexIncr;
		if (index >= WT_SIZE)
			index -= WT_SIZE;

		// printf("%u ", sample_val);
	}
	i2s_set_clk(I2S_NUM, SAMPLE_RATE, AUDIO_RESOLUTION_BIT, I2S_CHANNEL_STEREO);
	i2s_write(I2S_NUM, samples_data, data_size, &i2s_bytes_write, portMAX_DELAY);
	free(samples_data);
}

void sw_cb(void *args)
{
	encoder_write((encoder_states_t*)args, 0);
}

void app_main(void)
{
	i2s_config_t i2s_config = {
		.mode = I2S_MODE_MASTER | I2S_MODE_TX,
		.sample_rate = SAMPLE_RATE,
		.bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,
		.channel_format = I2S_CHANNEL_FMT_RIGHT_LEFT,
		.communication_format = I2S_COMM_FORMAT_STAND_MSB,
		.dma_buf_count = 8,
		.dma_buf_len = 128,
		.use_apll = false,
		.intr_alloc_flags = ESP_INTR_FLAG_LEVEL1 // Interrupt level 1
	};
	i2s_pin_config_t pin_config = {
		.bck_io_num = I2S_BCK_IO,
		.ws_io_num = I2S_WS_IO,
		.data_out_num = I2S_DO_IO,
		.data_in_num = I2S_DI_IO // Not used
	};
	i2s_driver_install(I2S_NUM, &i2s_config, 0, NULL);
	i2s_set_pin(I2S_NUM, &pin_config);

	encoder_states_t ec = {
		.state = 0,
		.position = 0,
		.cgf = {
			.pin_a = 38,
			.pin_b = 35,
			.pin_sw = 9,
			.sw_callback = sw_cb,
		},
	};

	
	encoder_init(&ec);
	init_wavetables();

	while (1)
	{
		i2s_write_freq(get_pitch_hz(abs(encoder_read(&ec))));
		vTaskDelay(5000 / portTICK_PERIOD_MS);
	}
}